<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="./shared-icons.html">

<link rel="lazy-import" href="home.html">
<link rel="lazy-import" href="officers.html">
<link rel="lazy-import" href="committees.html">
<link rel="lazy-import" href="tutoring.html">
<link rel="lazy-import" href="./404.html">


<dom-module id="my-app">
  <template>
    <style>
      :host {
        --app-primary-color: #4285f4;
        --app-secondary-color: #000;

        display: block;
      }
      
      .drawer-title {
        margin-left: 10px;
      }
      .drawer-list {
        margin: 0 20px;
      }
      .drawer-list a {
        display: block;
        padding: 0 16px;
        text-decoration: none;
        color: var(--app-secondary-color);
        line-height: 40px;
      }
      .drawer-list a.iron-selected {
        color: #000;
        font-weight: bold;
      }
      .spacer {
        height: 1em;
      }

      app-header {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 48px;
        z-index: 5;
      }
      app-toolbar {
        padding-left: 5px;
        height: 48px;
        background-color: #232323;
        color: #fff;
        --app-toolbar-font-size: 18px;
        position: sticky;
      }
      div[main-title] {
        margin-left: 20px;
      }
      paper-icon-button#menuIcon {
        width: 38px;
        height: 38px;
      }
      app-drawer {
        z-index: 10;
        
        --app-drawer-content-container: {
          background-color: #f1f1f1;
        }
      }

      #main {
        width: 100%;
        padding-top: 48px;
        height: calc(100vh - 48px);
      }
    </style>

    <app-location
        route="{{route}}"
        url-space-regex="^[[rootPath]]">
    </app-location>

    <app-route
        route="{{route}}"
        pattern="[[rootPath]]:page"
        data="{{routeData}}"
        tail="{{subroute}}">
    </app-route>

    <app-drawer id="drawer" swipe-open>
      <app-toolbar><div class="drawer-title">Menu</div></app-toolbar>
      <iron-selector selected="[[page]]" attr-for-selected="name" class="drawer-list" role="navigation">
        <a name="home" href="[[rootPath]]home">Home</a>
        <a name="officers" href="[[rootPath]]officers">Officers</a>
        <a name="committees" href="[[rootPath]]committees">Committees</a>
        <a name="tutoring" href="[[rootPath]]tutoring">Tutoring</a>
        <div class="spacer"></div>
        <a name="join" href="https://goo.gl/forms/27VNzLklSdBmFqgF3" target="_blank">Join Us!</a>
        <a name="contact" href="mailto:contact@ieeeutd.org">Contact Us!</a>
      </iron-selector>
    </app-drawer>

    <app-header slot="header" condenses reveals effects="waterfall">
      <app-toolbar>
        <paper-icon-button id="menuIcon" icon="shared-icons:menu" on-tap="menuAction"></paper-icon-button>
        <div main-title><b>IEEE UTD</b> &mdash; [[fancyPage]]</div>
      </app-toolbar>    
    </app-header>



    <iron-pages id="main"
        selected="[[page]]"
        attr-for-selected="name"
        fallback-selection="404"
        role="main">
      <view-home name="home"></view-home>
      <view-officers name="officers"></view-officers>
      <view-committees name="committees"></view-committees>
      <view-tutoring name="tutoring"></view-tutoring>
      <view-notfound name="404"></view-notfound>
    </iron-pages>
  </template>

  <script>
    // Gesture events like tap and track generated from touch will not be
    // preventable, allowing for better scrolling performance.
    Polymer.setPassiveTouchGestures(true);

    class MyApp extends Polymer.Element {
      static get is() { 
        return 'my-app'; 
      }
      
      static get properties() {
        return {
          scroll: {
            type: Boolean,
            value: true
          },
          page: {
            type: String,
            reflectToAttribute: true,
            observer: '_pageChanged',
          },
          fancyPage: {
            type: String,
            value: 'Home'
          },
          routeData: Object,
          subroute: Object,
          // This shouldn't be neccessary, but the Analyzer isn't picking up
          // Polymer.Element#rootPath
          rootPath: String,
        }
      }
      
      connectedCallback() {
        super.connectedCallback();
        var scroll = this.scroll;
        var observer = new MutationObserver(function(mutations) {
          mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes') {
              if (scroll) {
                disableScroll();
                scroll = false;
              } else {
                enableScroll();
                scroll = true;
              }
            }
          });    
        });
        var observerConfig = {
          attributes: true,
        };
        var targetNode = document.body;
        observer.observe(targetNode, observerConfig);
      }

      menuAction() {
        this.$.drawer.open();
      }

      static get observers() {
        return [
          '_routePageChanged(routeData.page)',
        ];
      }

      _routePageChanged(page) {
        this.page = page || 'home';
        if (page !== '' && page !== 'home' && page !== 'officers' && page !== 'committees' && page !== 'tutoring') {
          this.fancyPage = '404';
          document.title = 'IEEE UTD | 404';
        } else {
          this.fancyPage = page.charAt(0).toUpperCase() + page.slice(1) || 'Home';
          if (this.page == 'home') {
            document.title = 'IEEE UTD - The Student Chapter of IEEE at UTD';
          } else {
            document.title = 'IEEE UTD | ' + this.fancyPage;
          }
        }
        // Close a non-persistent drawer when the page & route are changed.
        if (!this.$.drawer.persistent) {
          this.$.drawer.close();
        }
      }

      _pageChanged(page) {
        // Load page import on demand. Show 404 page if fails
        const resolvedPageUrl = this.resolveUrl( page + '.html');
        Polymer.importHref(
            resolvedPageUrl,
            null,
            this._showPage404.bind(this),
            true);
        window.scrollTo(0, 0);
      }

      _showPage404() {
        this.page = '404';
      }
    }
    
    var keys = {37: 1, 38: 1, 39: 1, 40: 1};

    function preventDefault(e) {
      e = e || window.event;
      if (e.preventDefault)
          e.preventDefault();
      e.returnValue = false;  
    }

    function preventDefaultForScrollKeys(e) {
        if (keys[e.keyCode]) {
            preventDefault(e);
            return false;
        }
    }
    
    // adapted from https://stackoverflow.com/questions/4770025/how-to-disable-scrolling-temporarily
    function disableScroll() {
      if (window.addEventListener) {
        window.addEventListener('DOMMouseScroll', preventDefault, false);
      }
      window.onwheel = preventDefault;
      window.onmousewheel = document.onmousewheel = preventDefault;
      window.ontouchmove  = preventDefault; // mobile
      window.ontouchmove  = preventDefault; // repeated because parent layer 
      document.onkeydown  = preventDefaultForScrollKeys;
    }

    function enableScroll() {
        if (window.removeEventListener)
            window.removeEventListener('DOMMouseScroll', preventDefault, false);
        window.onmousewheel = document.onmousewheel = null; 
        window.onwheel = null; 
        window.ontouchmove = null;  
        document.onkeydown = null;  
    }

    window.customElements.define(MyApp.is, MyApp);
  </script>
</dom-module>
